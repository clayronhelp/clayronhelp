<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Calendario - ClayRon</title>
  <link rel="icon" href="assets/img/logo.png">
  <!-- CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    #calendar { max-width: 900px; margin: 0 auto; }
  </style>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL  = 'https://nptawehzfamaghytkmbk.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5wdGF3ZWh6ZmFtYWdoeXRrbWJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4NzAyMzEsImV4cCI6MjA2MTQ0NjIzMX0.FifPP4WNg7hDFucB_1gBuJQCG4993mBYiKbNyQjpAM8';
    window.supabase     = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  </script>
  <script src="assets/js/auth.js"></script>
</head>
<body class="d-flex flex-column min-vh-100">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <img src="assets/img/logo.png" alt="Logo" class="logo" style="height:32px"> ClayRon S.P.A.
      </a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavHome">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavHome">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="materials.html">Materiali</a></li>
          <li class="nav-item"><a class="nav-link" href="about.html">Chi Siamo</a></li>
          <li class="nav-item"><a class="nav-link" href="contact.html">Contatti</a></li>
        </ul>
        <div id="auth-area" class="ml-2"><!-- auth.js popolerà qui --></div>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="container flex-fill py-5">
    <h2 class="mb-4 text-center">Calendario</h2>
    <div id="calendar"></div>
  </main>

  <!-- Footer -->
  <footer class="py-4 bg-primary text-white text-center mt-auto">
    <div class="container">
      <div class="social-icons mb-3">
        <a href="https://www.instagram.com/clayronhelp/" class="text-white mx-2"><i class="fab fa-instagram"></i></a>
        <a href="https://www.facebook.com/61575494257613" class="text-white mx-2"><i class="fab fa-facebook-f"></i></a>
        <a href="https://www.tiktok.com/@clayronhelp" class="text-white mx-2"><i class="fab fa-tiktok"></i></a>
      </div>
      <p>&copy; 2025 ClayRon S.P.A. Tutti i diritti riservati.</p>
      <small>
        <a href="terms.html" class="text-white">Termini &amp; Condizioni</a> – 
        <a href="cookie.html" class="text-white">Cookie Policy</a>
      </small>
    </div>
  </footer>

  <!-- Modal per nuovo evento -->
  <div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Nuovo evento</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Chiudi">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="eventTitle">Titolo</label>
            <input type="text" id="eventTitle" class="form-control" placeholder="Es: Verifica Italiano">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Annulla</button>
          <button type="button" id="saveEventBtn" class="btn btn-primary">Salva</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    // 1) Sessione + Navbar
    const { data:{ session } } = await supabase.auth.getSession();
    if (!session) return window.location.href = 'login.html';
    await updateNavbar();

    const userId = session.user.id;
    let pendingInfo = null;

    // 2) Funzione per upsert su Supabase
    async function upsertEvent(ev) {
      const { error } = await supabase
        .from('events')
        .upsert({
          id:        ev.id,
          user_id:   userId,
          title:     ev.title,
          start:     ev.start,
          all_day:   ev.allDay
        }, { onConflict: 'id' });
      if (error) console.error('Upsert failed:', error);
    }

    // 3) Inizializza FullCalendar
    const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
      locale: 'it',
      firstDay: 1,
      initialView: 'dayGridMonth',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      selectable: true,
      select: info => {
        pendingInfo = info;
        $('#eventTitle').val('');
        $('#eventModal').modal('show');
      },
      events: async function(fetchInfo, successCallback) {
        // prendi solo gli eventi di questo utente
        let { data, error } = await supabase
          .from('events')
          .select('*')
          .eq('user_id', userId)
          .order('start', { ascending: true });
        if (error) return console.error(error);
        successCallback(data.map(e => ({
          id:      e.id,
          title:   e.title,
          start:   e.start,
          allDay:  e.all_day
        })));
      },
      eventClick: async info => {
        if (!confirm(`Eliminare "${info.event.title}"?`)) return;
        // elimina da calendario e da Supabase
        await supabase
          .from('events')
          .delete()
          .eq('id', info.event.id);
        info.event.remove();
      }
    });
    calendar.render();

    // 4) Salvataggio dal modale
    document.getElementById('saveEventBtn').addEventListener('click', async () => {
      const titolo = document.getElementById('eventTitle').value.trim();
      if (!titolo) return alert('Inserisci un titolo valido!');
      $('#eventModal').modal('hide');

      const ev = {
        id:       crypto.randomUUID(),
        title:    titolo,
        start:    pendingInfo.startStr,
        allDay:   true
      };
      calendar.addEvent(ev);
      await upsertEvent(ev);
      calendar.unselect();
    });
  });
  </script>

</body>
</html>
