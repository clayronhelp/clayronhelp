<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Profilo - ClayRon</title>
  <link rel="icon" href="assets/img/logo.png" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <script src="https://unpkg.com/@supabase/supabase-js/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL = 'https://nptawehzfamaghytkmbk.supabase.co';
    const SUPABASE_ANON = '<YOUR_ANON_KEY>';
    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  </script>
</head>
<body class="d-flex flex-column min-vh-100">
  <!-- Navbar dinamica -->

  <main class="container py-5 flex-fill">
    <h2>Modifica Profilo</h2>
    <form id="profileForm">
      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="name">Nome</label>
          <input type="text" id="name" class="form-control">
        </div>
        <div class="form-group col-md-6">
          <label for="surname">Cognome</label>
          <input type="text" id="surname" class="form-control">
        </div>
      </div>
      <div class="form-group">
        <label for="profilePicture">Foto Profilo</label>
        <input type="file" id="profilePicture" class="form-control-file">
      </div>
      <button type="submit" class="btn btn-primary">Salva Modifiche</button>
    </form>
    <div id="profileAlert" class="mt-3"></div>
  </main>

  <footer class="bg-primary text-white text-center py-4 mt-auto">
    <div class="container">&copy; 2025 ClayRon S.P.A.</div>
  </footer>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script>
    $(async ()=>{
      const { data:{ session } } = await supabase.auth.getSession();
      const user = session.user;
      $('#name').val(user.user_metadata.name||'');
      $('#surname').val(user.user_metadata.surname||'');
    });
    $('#profileForm').submit(async e=>{
      e.preventDefault();
      const name = $('#name').val(), surname = $('#surname').val();
      let updates = { name, surname };
      const file = $('#profilePicture')[0].files[0];
      if(file) {
        const { data, error } = await supabase.storage
          .from('avatars').upload(`${Date.now()}_${file.name}`, file);
        if(error) return $('#profileAlert').html('<div class="alert alert-danger">Errore upload</div>');
        updates.avatar_url = data.path;
      }
      const { error:updateErr } = await supabase.auth.updateUser({ data: updates });
      if(updateErr) return $('#profileAlert').html('<div class="alert alert-danger">'+updateErr.message+'</div>');
      $('#profileAlert').html('<div class="alert alert-success">Profilo aggiornato!</div>');
    });
  </script>
</body>
</html>