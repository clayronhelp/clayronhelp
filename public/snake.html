<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Snake – ClayRon</title>
  <!-- include layout -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    #board { background:#fff; border:2px solid #0055aa; display:block; margin:auto; }
    #controls { text-align:center; margin-top:1rem; }
    #controls button { margin:0 .5rem; }
    #score { font-weight:600; margin-bottom:1rem; text-align:center; }
  </style>
</head>
<body>

  <!-- Navbar + Footer tramite include (v. sopra) -->

  <div class="container game-container text-center">
    <h2>Snake</h2>
    <div id="score">Score: 0</div>
    <canvas id="board" width="400" height="400"></canvas>
    <div id="controls">
      <button id="startBtn" class="btn btn-success">Start</button>
      <button id="resetBtn" class="btn btn-warning">Reset</button>
    </div>
  </div>

  <script>
  (() => {
    const cvs = document.getElementById('board'),
          ctx = cvs.getContext('2d');
    const size=20, cols=20, rows=20;
    let snake, dir, food, score, loop;

    function init(){
      clearInterval(loop);
      snake=[{x:10,y:10}];
      dir={x:1,y:0};
      score=0; document.getElementById('score').innerText='Score: 0';
      placeFood(); draw();
    }

    function placeFood(){
      food={ x:Math.floor(Math.random()*cols), y:Math.floor(Math.random()*rows) };
    }

    function draw(){
      ctx.fillStyle='#fff'; ctx.fillRect(0,0,cvs.width,cvs.height);
      ctx.fillStyle='#e63946';
      ctx.fillRect(food.x*size, food.y*size, size-2, size-2);
      ctx.fillStyle='#0055aa';
      snake.forEach(s => ctx.fillRect(s.x*size, s.y*size, size-2, size-2));
    }

    function update(){
      const head={ x:snake[0].x+dir.x, y:snake[0].y+dir.y };
      // collisione muro = game over
      if (head.x<0||head.x>=cols||head.y<0||head.y>=rows) {
        clearInterval(loop);
        alert('Hai perso! Punteggio: '+score);
        return;
      }
      // collisione con sé stessi
      if (snake.some(s=>s.x===head.x&&s.y===head.y)) {
        clearInterval(loop);
        alert('Hai perso! Punteggio: '+score);
        return;
      }
      snake.unshift(head);
      if (head.x===food.x&&head.y===food.y) {
        score++; document.getElementById('score').innerText='Score: '+score;
        placeFood();
      } else snake.pop();
      draw();
    }

    document.getElementById('startBtn').onclick = () => {
      clearInterval(loop);
      loop = setInterval(update, 120);
    };
    document.getElementById('resetBtn').onclick = init;

    document.addEventListener('keydown', e => {
      if (e.key==='ArrowUp'&& dir.y===0) dir={x:0,y:-1};
      if (e.key==='ArrowDown'&& dir.y===0) dir={x:0,y:1};
      if (e.key==='ArrowLeft'&& dir.x===0) dir={x:-1,y:0};
      if (e.key==='ArrowRight'&&dir.x===0) dir={x:1,y:0};
    });

    init();
  })();

  // gestione leaderboard
function saveScore(score){
  const { user } = supabase.auth.getSession().data.session;
  const nome = user.user_metadata.firstName+' '+user.user_metadata.lastName;
  const key='clayron_leader_'+window.location.pathname;
  const arr = JSON.parse(localStorage.getItem(key) || '[]');
  arr.push({ nome, score, time:Date.now() });
  localStorage.setItem(key, JSON.stringify(arr));
}
function showLeaderboard(){
  const key='clayron_leader_'+window.location.pathname;
  const arr = JSON.parse(localStorage.getItem(key)||'[]')
               .sort((a,b)=>b.score-a.score).slice(0,5);
  let html='<ul class="list-group">';
  arr.forEach(e=> html+=`<li class="list-group-item">${e.nome}: ${e.score}</li>`);
  html+='</ul>';
  document.getElementById('leaderboard').innerHTML=html;
  document.getElementById('leaderboard').style.display='block';
}
document.getElementById('showLeaderboard').onclick = showLeaderboard;
// alla fine di ogni gioco, chiamare saveScore(score);

  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/js/all.min.js"></script>
</body>
</html>
