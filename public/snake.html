<!DOCTYPE html>
<html lang="it"><head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Snake – ClayRon</title>
  <link rel="icon" href="assets/img/logo.png">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body, canvas { display:flex; justify-content:center; align-items:center; height:100vh; background:#f0f8ff; }
    #gameContainer { text-align:center; }
    #board { border:2px solid #003366; background:#e0ffff; }
    #touchControls button { width:50px; margin:5px; }
    #toggleBoard { margin-top:10px; }
    #boardList .list-group-item { background:#e9f7ff; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL='https://nptawehzfamaghytkmbk.supabase.co',
          SUPABASE_ANON='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9…';
    window.supabase = supabase.createClient(SUPABASE_URL,SUPABASE_ANON);
  </script>
  <script src="assets/js/auth.js"></script>
</head><body>
  <div id="gameContainer">
    <h2>Snake</h2>
    <canvas id="board" width="400" height="400"></canvas>
    <!-- touch controls -->
    <div id="touchControls" class="d-md-none">
      <button data-dir="up" class="btn btn-secondary">▲</button><br>
      <button data-dir="left" class="btn btn-secondary">◀</button>
      <button data-dir="right" class="btn btn-secondary">▶</button><br>
      <button data-dir="down" class="btn btn-secondary">▼</button>
    </div>
    <button id="toggleBoard" class="btn btn-outline-primary">Mostra Classifica</button>
    <ol id="boardList" class="list-group collapse"></ol>
  </div>

<script>
document.addEventListener('DOMContentLoaded', async()=>{
  // 1) sessione + navbar
  const { data:{session} } = await supabase.auth.getSession();
  if(!session) return location.href='login.html';
  await updateNavbar();
  const userName = session.user.user_metadata.firstName
    ? `${session.user.user_metadata.firstName} ${session.user.user_metadata.lastName}`
    : session.user.email;
  // 2) leaderboard toggle
  $('#toggleBoard').click(()=>$('#boardList').collapse('toggle'));

  // 3) load leaderboard
  async function loadBoard(){
    const { data } = await supabase.from('snake_scores')
      .select('*').order('score',{ascending:false}).limit(10);
    $('#boardList').empty();
    data.forEach(r=>$('#boardList')
      .append(`<li class="list-group-item">${r.name} — ${r.score}</li>`));
  }
  loadBoard();

  // 4) game logic
  const cvs = document.getElementById('board'),
        ctx = cvs.getContext('2d');
  const grid=20, cols=cvs.width/grid, rows=cvs.height/grid;
  let snake=[{x:10,y:10}], dir={x:1,y:0}, food={}, score=0;
  function placeFood(){
    food={ x:Math.floor(Math.random()*cols),
           y:Math.floor(Math.random()*rows) };
  }
  function draw(){
    ctx.fillStyle='#e0ffff'; ctx.fillRect(0,0,cvs.width,cvs.height);
    // snake
    ctx.fillStyle='#003366';
    snake.forEach(seg=>ctx.fillRect(seg.x*grid,seg.y*grid,grid-2,grid-2));
    // food
    ctx.fillStyle='#ff4500';
    ctx.fillRect(food.x*grid,food.y*grid,grid-2,grid-2);
  }
  function update(){
    const head={x:snake[0].x+dir.x, y:snake[0].y+dir.y};
    // wall wrap
    head.x = (head.x+cols)%cols;
    head.y = (head.y+rows)%rows;
    // self collision
    if(snake.some(s=>s.x===head.x&&s.y===head.y)){
      clearInterval(loop);
      submitScore();
      return alert('Game Over');
    }
    snake.unshift(head);
    if(head.x===food.x&&head.y===food.y){
      score++;
      placeFood();
    } else snake.pop();
    draw();
  }
  function submitScore(){
    supabase.from('snake_scores').insert([{ name:userName, score }]);
    loadBoard();
  }
  placeFood();
  const loop = setInterval(update,100);

  // keyboard
  window.onkeydown=e=>{
    if(e.key==='ArrowUp'&&dir.y===0) dir={x:0,y:-1};
    if(e.key==='ArrowDown'&&dir.y===0) dir={x:0,y:1};
    if(e.key==='ArrowLeft'&&dir.x===0) dir={x:-1,y:0};
    if(e.key==='ArrowRight'&&dir.x===0) dir={x:1,y:0};
  };
  // touch
  $('#touchControls button').click(function(){
    const d=$(this).data('dir');
    if(d==='up'&&dir.y===0) dir={x:0,y:-1};
    if(d==='down'&&dir.y===0) dir={x:0,y:1};
    if(d==='left'&&dir.x===0) dir={x:-1,y:0};
    if(d==='right'&&dir.x===0) dir={x:1,y:0};
  });
});
</script>
</body></html>
